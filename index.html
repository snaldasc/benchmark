<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>SpotScout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Leaflet Stylesheet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="styles.css" />

  <!-- PushAlert -->
  <script type="text/javascript">
    (function(d, t) {
      var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
      g.src = "https://cdn.pushalert.co/integrate_0499cf29ad644996d9398435d3801c7e.js";
      s.parentNode.insertBefore(g, s);
    })(document, "script");
  </script>
</head>
<body>
  <header>
    <h1>SpotScout</h1>
    <button id="menuToggle">‚ò∞</button>
    <button id="toggleLayer">üõ∞ Satellit an/aus</button>
    <h1><span id="locationCount">0</span> locations available</h1>

  </header>

  <div id="menuOverlay" class="hidden"></div>

  <nav id="sideMenu" class="hidden">
    <label for="tagFilter">Filter Tags:</label>
    <select id="tagFilter"><option value="all">All</option></select>
    <br>
    <label for="typeFilter">Filter Type:</label>
    <select id="typeFilter"><option value="all">All</option></select>
    <br>
    <label for="countrySelect">Filter Country:</label> 
    <select id="countrySelect"><option value="all">All</option></select>

    <ul id="locationList"></ul>
    <button id="resetMap">üìç back to your position</button>
    <hr />
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdLJKF-C_VVNV0OK-bEY7d_JMTqMHZUXyd4rtz-PTOwwyyU7w/viewform?usp=dialog">
      <button>submit location</button>
    </a>
    <a href="https://buymeacoffee.com/spotscout" target="_blank">
      <button>be a supporter</button>
    </a>
  </nav>

  <main>
    <div id="map"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const map = L.map('map').setView([53.5716, 9.6740], 14);
      let userLatLng = null;
      let markers = [];
      let userMarker = null;

      osmLayer.addTo(map);

      map.zoomControl.remove();

      document.getElementById("menuToggle").addEventListener("click", () => {
        document.getElementById("sideMenu").classList.toggle("hidden");
      });

      navigator.geolocation.getCurrentPosition(
        pos => {
          userLatLng = [pos.coords.latitude, pos.coords.longitude];
          map.setView(userLatLng, 14);
          userMarker = L.marker(userLatLng, {
            icon: L.icon({
              iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
            })
          }).addTo(map).bindPopup("You are here").openPopup();
        },
        () => console.log("Position not available")
      );

      fetch("https://raw.githubusercontent.com/snaldasc/benchmark/main/locations.json")
        .then(res => res.json())
        .then(data => {
          renderMarkers(data);
          initializeTagFilter(data);
          initializeTypeFilter(data);
          initializeCountryFilter(data);
          updateLocationCount(data.length);

          const tagFilter = document.getElementById("tagFilter");
          const typeFilter = document.getElementById("typeFilter");
          const countryFilter = document.getElementById("countrySelect");

          function applyFilters() {
            const selectedTag = tagFilter.value.toLowerCase();
            const selectedType = typeFilter.value.toLowerCase();
            const selectedCountry = countryFilter.value.toLowerCase();

            const filtered = data.filter(loc => {
              const tagMatch = selectedTag === "all" || loc.tags.some(tag => tag.toLowerCase() === selectedTag);
              const typeMatch = selectedType === "all" || (loc.type && loc.type.toLowerCase() === selectedType);
              const countryMatch = selectedCountry === "all" || (loc.country && loc.country.toLowerCase() === selectedCountry);
              return tagMatch && typeMatch && countryMatch;
            });

            renderMarkers(filtered);
            updateLocationCount(filtered.length);
          }

          tagFilter.addEventListener("change", applyFilters);
          typeFilter.addEventListener("change", applyFilters);
          countryFilter.addEventListener("change", applyFilters);
        });

      function renderMarkers(locations) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        const list = document.getElementById("locationList");
        list.innerHTML = "";

        locations.forEach(loc => {
          const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          });

          const marker = L.marker([loc.latitude, loc.longitude], { icon: redIcon }).addTo(map);

          const popupContent = `
            <strong>${loc.name}</strong><br>
            <img src="${loc.image}" alt="${loc.name}" class="popup-img" style="width:100%;max-width:200px;cursor:pointer;"><br>
            <p>${loc.description}</p>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.latitude},${loc.longitude}" target="_blank" style="color:blue;font-weight:bold;text-decoration:underline;">
              ‚û§ Route in Google Maps
            </a>
          `;
          marker.bindPopup(popupContent);
          markers.push(marker);

          const li = document.createElement("li");
          li.textContent = loc.name;
          li.addEventListener("click", () => {
            map.setView([loc.latitude, loc.longitude], 16);
            marker.openPopup();
          });
          list.appendChild(li);
        });
      }

      function initializeTagFilter(data) {
        const tagFilter = document.getElementById("tagFilter");
        const allTags = new Set();
        data.forEach(loc => loc.tags.forEach(tag => allTags.add(tag.toLowerCase())));
        allTags.forEach(tag => {
          const option = document.createElement("option");
          option.value = tag;
          option.textContent = tag;
          tagFilter.appendChild(option);
        });
      }

      function initializeTypeFilter(data) {
        const typeFilter = document.getElementById("typeFilter");
        const allTypes = new Set();
        data.forEach(loc => loc.type && allTypes.add(loc.type.toLowerCase()));
        allTypes.forEach(type => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          typeFilter.appendChild(option);
        });
      }

      function initializeCountryFilter(data) {
        const countrySelect = document.getElementById("countrySelect");
        const countries = new Set();
        data.forEach(loc => {
          if (loc.country) countries.add(loc.country);
        });
        Array.from(countries).sort().forEach(country => {
          const option = document.createElement("option");
          option.value = country.toLowerCase();
          option.textContent = country;
          countrySelect.appendChild(option);
        });
      }

      function updateLocationCount(count) {
        document.getElementById("locationCount").textContent = count;
      }

      document.getElementById("resetMap").addEventListener("click", () => {
        if (userLatLng) {
          map.setView(userLatLng, 14);
        } else {
          map.setView([40, 10], 14);
        }
      });

      // ========== NEU: Spot hinzuf√ºgen durch Klick ==========
      map.on("click", function (e) {
  const { lat, lng } = e.latlng;
  const popupForm = `
    <form id="spotForm">
      <strong>üìå Submit new Spot</strong><br>
      <input name="title" placeholder="Name" required style="width: 100%; margin: 4px 0;"><br>
      <textarea name="description" placeholder="Description" style="width: 100%; margin: 4px 0;"></textarea><br>
      <input name="image" placeholder="Bild-URL (optional)" style="width: 100%; margin: 4px 0;"><br>
      <input name="tags" placeholder="Tags (z.‚ÄØB. view description, water, Skate, Lostplace, parkour)" style="width: 100%; margin: 4px 0;"><br>
      <input name="type" placeholder="Type of location (z.‚ÄØB. bench, picknick, viewpoint etc.)" style="width: 100%; margin: 4px 0;"><br>
      <input type="hidden" name="lat" value="${lat}">
      <input type="hidden" name="lng" value="${lng}">
      <button type="submit" style="margin-top: 4px;">‚úÖ Absenden</button>
    </form>
  `;
  L.popup().setLatLng([lat, lng]).setContent(popupForm).openOn(map);
});


      // Neuen Spot via Discord Webhook absenden
     document.addEventListener("submit", async (e) => {
  if (e.target.id === "spotForm") {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    const webhookUrl = "https://discord.com/api/webhooks/1372966787578069113/SwKAcsG_BEh3IuP6WHLOOUJI-flnZ-vbWamVuXhPO1CXTUUHsYnpH9RpEXEoB5UzELW5"; // ‚Üê deine echte Webhook-URL

    const payload = {
      username: "SpotScout Bot",
      embeds: [{
        title: "üìç Neuer Spot eingereicht",
        color: 0x00b0f4,
        fields: [
          { name: "Name", value: data.title || "-" },
          { name: "Beschreibung", value: data.description || "-" },
          { name: "Bild", value: data.image || "-" },
          { name: "Tags", value: data.tags || "-" },
          { name: "Typ", value: data.type || "-" },
          { name: "Koordinaten", value: `${data.lat}, ${data.lng}` }
        ],
        ...(data.image ? { image: { url: data.image } } : {}),
        footer: { text: "Eingereicht √ºber SpotScout Map" }
      }]
    };

    try {
      const response = await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        alert("üéâ Danke! Dein Spot wurde gesendet.");
      } else {
        alert("‚ùå Fehler beim Senden. Bitte erneut versuchen.");
      }
    } catch (err) {
      alert("‚ùå Verbindung fehlgeschlagen.");
    }

    map.closePopup();
  }
});


      // ========== Modal Bildanzeige ==========
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImg");
      const closeBtn = document.querySelector("#imageModal .close");

      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("popup-img")) {
          modal.style.display = "block";
          modal.classList.remove("hidden");
          modalImg.src = e.target.src;
          modalImg.classList.remove("zoomed");
          document.body.style.overflow = "hidden";
        }
      });

      if (closeBtn && modal && modalImg) {
        closeBtn.onclick = () => {
          modal.style.display = "none";
          modal.classList.add("hidden");
          modalImg.classList.remove("zoomed");
          document.body.style.overflow = "";
        };

        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
            modal.classList.add("hidden");
            modalImg.classList.remove("zoomed");
            document.body.style.overflow = "";
          }
        };

        modalImg.addEventListener("click", () => {
          modalImg.classList.toggle("zoomed");
        });
      }
    });

    // === Satellitenumschaltung hinzuf√ºgen ===
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap-Mitwirkende'
});

const esriSatLayer = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {
    attribution: 'Tiles ¬© Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye'
  }
);

// Anfangszustand
let isSatellite = false;
osmLayer.addTo(map); // bereits geschehen, aber zur Sicherheit

document.getElementById("toggleLayer").addEventListener("click", () => {
  if (isSatellite) {
    map.removeLayer(esriSatLayer);
    map.addLayer(osmLayer);
  } else {
    map.removeLayer(osmLayer);
    map.addLayer(esriSatLayer);
  }
  isSatellite = !isSatellite;
});

  </script>

  <!-- Modal f√ºr Bildanzeige -->
  <div id="imageModal" class="hidden">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImg" />
  </div>
</body>
</html>
